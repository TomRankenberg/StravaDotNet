@page "/history"
@using Data.Models.Strava
@using StravaDotNet.ViewModels
@using StravaDotNet.Components.Services
@using MudBlazor
@inject DetailedActivityService DetailedActivityService
@rendermode InteractiveServer

<PageTitle>Activity History</PageTitle>

<form>
    <button type="button" class="btn btn-secondary" style="margin-right:30px;" @onclick="LoadData">Load Data</button>
</form>

<MudTable Items="simpleActivities" Hover="true">
    <HeaderContent>
        <MudTh>Type</MudTh>
        <MudTh>Date</MudTh>
    </HeaderContent>
    <RowTemplate>
        <MudTd>
            <MudIcon Icon="@GetIcon(context.Type)" />
        </MudTd>
        <MudTd>@context.StartDate.ToString("dd/MM/yyyy")</MudTd>
    </RowTemplate>
</MudTable>

@code {
    private List<ActivityVm> detailedActivities;
    private List<SimpleActivity> simpleActivities;

    private async Task LoadData()
    {
        detailedActivities = await DetailedActivityService.GetDetailedActivityVmsAsync();
        simpleActivities = new List<SimpleActivity>();
        foreach (ActivityVm activity in detailedActivities)
        {
            if (activity.Activity.StartDate.HasValue && activity.Activity.Type != null)
            {
                simpleActivities.Add(new SimpleActivity
                    {
                        Type = activity.Activity.Type,
                        StartDate = activity.Activity.StartDate.Value
                    });
            }
        }
		simpleActivities = simpleActivities.OrderByDescending(x => x.StartDate).ToList();
    }

    private string GetIcon(string type)
    {
        return type switch
        {
            "Run" => Icons.Material.Filled.DirectionsRun,
            "Ride" => Icons.Material.Filled.DirectionsBike,
            "Swim" => Icons.Material.Filled.Pool,
            _ => Icons.Material.Filled.Help
        };
    }

    private class SimpleActivity
    {
        public string Type { get; set; }
        public DateTime StartDate { get; set; }
    }
}
