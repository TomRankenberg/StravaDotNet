@page "/history"
@using Data.Models.Strava
@using StravaDotNet.ViewModels
@using StravaDotNet.Components.Services
@using MudBlazor
@inject NavigationManager Navigation
@inject AuthState AuthState
@inject DetailedActivityService DetailedActivityService
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer

<PageTitle>Activity History</PageTitle>

<form>
    <button type="button" class="btn btn-secondary" style="margin-right:30px;" @onclick="LoadData">Load Data</button>
</form>

<MudTimeline Reverse="true">
    @if (simpleActivities != null)
    {
        foreach (var activity in simpleActivities)
        {
            <MudTimelineItem>
                <ChildContent>
                    <MudPaper Class="pa-2 d-flex align-items-center">
                        <MudIcon Icon="@GetIcon(activity.Type)" Class="me-2 timeline-icon-small" />
                        <span class="me-3">@activity.StartDate.ToString("dd/MM/yyyy")</span>
                        <span>@activity.Distance</span>
                    </MudPaper>
                </ChildContent>
            </MudTimelineItem>
        }
    }
</MudTimeline>

@code {
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var isLoggedIn = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "isLoggedIn");
            AuthState.IsLoggedIn = isLoggedIn == "true";
            StateHasChanged();
        }
    }
    private List<ActivityVm> detailedActivities;
    private List<SimpleActivity> simpleActivities;

    private async Task LoadData()
    {
        detailedActivities = await DetailedActivityService.GetDetailedActivityVmsAsync();
        simpleActivities = new List<SimpleActivity>();
        foreach (ActivityVm activity in detailedActivities)
        {
            if (activity.Activity.StartDate.HasValue && activity.Activity.Type != null)
            {
                simpleActivities.Add(new SimpleActivity
                    {
                        Type = activity.Activity.Type,
                        StartDate = activity.Activity.StartDate.Value,
						Distance = activity.Activity.Distance.HasValue
								? $"{(activity.Activity.Distance.Value / 1000):F2} km"
								: "N/A"
                    });
            }
        }
		simpleActivities = simpleActivities.OrderByDescending(x => x.StartDate).ToList();
    }

    private string GetIcon(string type)
    {
        return type switch
        {
            "Run" => Icons.Material.Filled.DirectionsRun,
            "Ride" => Icons.Material.Filled.DirectionsBike,
            "Swim" => Icons.Material.Filled.Pool,
            _ => Icons.Material.Filled.Help
        };
    }

    private class SimpleActivity
    {
        public string Type { get; set; }
        public DateTime StartDate { get; set; }
		public string Distance { get; set; }
	}
}
<style>
    .timeline-icon-small {
        font-size: 32px;
        width: 32px;
        height: 32px;
    }
</style>