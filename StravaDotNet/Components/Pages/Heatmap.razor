@page "/heatmap"
@inject HttpClient Http
@using DataManagement.Models
@using Microsoft.JSInterop
@inject IJSRuntime JSRuntime
@using Data.Models.Strava

@using System.Text.Json;
@rendermode InteractiveServer

<h3>Heatmap</h3>
<div>
    <form>
        <button type="button" class="btn btn-primary" @onclick="GetHeatmap">Load heatmap</button>
    </form>
</div>
<div id="map" style="width: 70%; height: 700px;"></div>
<p>Number of activities plotted: @polylineCount</p>
@code {
    private List<string> polylines = new List<string>();
    private int polylineCount = 0;

    private List<LatLng> latLngs = new List<LatLng>();
	private HeatMapData heatMapData = new HeatMapData();
	private string heatMapDataString = "";
    private async Task GetHeatmap()
    {
        try
        {
            heatMapData = await Http.GetFromJsonAsync<HeatMapData>("https://localhost:7237/api/Heatmap/GetHeatmap?activity=Run");

			heatMapDataString = JsonSerializer.Serialize(heatMapData);
            polylines = heatMapData.Input.Select(i => i.EncodedPolyline).ToList();

            await InitializeMap();
            polylineCount = polylines.Count;

        }
        catch (Exception ex)
        {
            Console.WriteLine($"Exception: {ex.Message}");
        }
    }

    private async Task PolyLinesToLatLngs()
    {
        var latLngsDirect = await JSRuntime.InvokeAsync<List<LatLng>>("polylinesToLatLngs", polylines);
        latLngs = latLngsDirect;
    }

    private async Task InitializeMap()
    {
        await JSRuntime.InvokeVoidAsync("initializeHeatMap", heatMapDataString);
    }

    public class JsonResponse
    {
        public string Url { get; set; }
    }
}


