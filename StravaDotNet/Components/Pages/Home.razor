@page "/"
@inject HttpClient Http
@inject IJSRuntime JSRuntime
@using Contracts.Interfaces
@using Services
@inject NavigationManager Navigation
@inject AuthState AuthState
@inject IAuthService AuthService
@rendermode InteractiveServer
@inject Microsoft.Extensions.Options.IOptions<AppSettings> Options

<PageTitle>Home</PageTitle>

<form>
    <button type="button" style="border: none; background: none; padding: 0;" @onclick="ConnectToStrava">
        <img src="images/btn_strava_connect_with_white.png" alt="Connect to Strava" style="height: 48px; cursor: pointer;" />
    </button>
	<br />
    <br/>
    <button type="button" class="btn btn-secondary" @onclick="Disconnect">Disconnect</button>
</form>

@code {
    private bool isAuth0LoggedIn;
    private bool isStravaConnected;

    protected override async Task OnInitializedAsync()
    {
        // AuthState now reflects Auth0 login via AuthenticationStateProvider.
        isAuth0LoggedIn = await AuthState.GetIsLoggedInAsync();

        if (!isAuth0LoggedIn)
        {
            // User is not signed in with Auth0 — do not attempt to validate Strava credentials.
            isStravaConnected = false;
            return;
        }

        // If signed in to Auth0, check Strava connection / token expiry via your existing service.
        try
        {
            IStravaUser user = await AuthService.ValidateCredentialsAsync();
            if (int.TryParse(user.AccessTokenExpiresAt, out var secondsEpoch))
            {
                DateTime tokenExpiryDateTime = DateTimeOffset.FromUnixTimeSeconds(secondsEpoch).UtcDateTime;
                isStravaConnected = tokenExpiryDateTime > DateTime.UtcNow;
            }
            else
            {
                isStravaConnected = false;
            }
        }
        catch
        {
            isStravaConnected = false;
        }
    }

    private async Task ConnectToStrava()
    {
        // Require Auth0 login first.
        if (!isAuth0LoggedIn)
        {
            // Redirect to the AccountController login which triggers Auth0 challenge.
            Navigation.NavigateTo("/account/login", true);
            return;
        }

        try
        {
            HttpResponseMessage response = await Http.GetAsync($"{Options.Value.BaseAddress}/api/Strava/ConnectToStrava");
            if (response.IsSuccessStatusCode)
            {
                JsonResponse? jsonResponse = await response.Content.ReadFromJsonAsync<JsonResponse>();
                string? stravaAuthUrl = jsonResponse?.Url;
                if (!string.IsNullOrEmpty(stravaAuthUrl))
                {
                    // Open Strava auth in a new window/tab
                    await JSRuntime.InvokeVoidAsync("eval", $"let _discard_ = open(`{stravaAuthUrl}`, `_blank`)");
                    // Mark optimistic state — actual confirmation will come when the callback completes and you validate credentials again.
                    isStravaConnected = true;
                    StateHasChanged();
                }
            }
            else
            {
                isStravaConnected = false;
                Console.WriteLine("Error calling ConnectToStrava");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Exception: {ex.Message}");
        }
    }

    private async Task Disconnect()
    {
        // Remove stored Strava credentials from your backend/service.
        await AuthService.RemoveCredentialsAsync();

        // Do not change AuthState here — AuthState is authoritative for Auth0 login status.
        isStravaConnected = false;

        // Optionally sign the user out of Auth0 as well:
        // Navigation.NavigateTo("/account/logout", true);

        Navigation.NavigateTo("/", true);
        StateHasChanged();
    }

    public class JsonResponse
    {
        public string? Url { get; set; }
    }
}