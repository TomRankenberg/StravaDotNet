@page "/fetchdata"
@using System.Text.Json
@using Contracts.Interfaces
@using Services
@inject NavigationManager Navigation
@inject AuthState AuthState
@inject IAuthService AuthService
@inject HttpClient Http
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer
@inject Microsoft.Extensions.Options.IOptions<AppSettings> Options

@code {
    private bool isLoading = false;
    private bool isDataLoaded = false;
    private bool isStravaConnected;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            bool isLoggedIn = await AuthState.GetIsLoggedInAsync();
            if (!isLoggedIn)
            {
                Navigation.NavigateTo("/account/login", true);
            }
            else
            {
                StateHasChanged();
            }
        }
    }

    private async Task ConnectToStrava()
    {
        IStravaUser user = await AuthService.ValidateCredentialsAsync();
        isStravaConnected = CheckIfCredentialsValid(user);
        if (isStravaConnected)
        {
            Console.WriteLine("Strava is already connected.");
            return;
        }
        else
        {
			isStravaConnected = await UpdateStravaCredentials();
			StateHasChanged();
        };

    }

    private async Task<bool> UpdateStravaCredentials()
    {
		bool isConnected = false;
        HttpResponseMessage response = await Http.GetAsync($"{Options.Value.BaseAddress}/api/Strava/ConnectToStrava");
        if (response.IsSuccessStatusCode)
        {
            JsonResponse? jsonResponse = await response.Content.ReadFromJsonAsync<JsonResponse>();
            string? stravaAuthUrl = jsonResponse?.Url;
            if (!string.IsNullOrEmpty(stravaAuthUrl))
            {
                // Open Strava auth in a new window/tab
                await JSRuntime.InvokeVoidAsync("eval", $"let _discard_ = open(`{stravaAuthUrl}`, `_blank`)");
                // Mark optimistic state — actual confirmation will come when the callback completes and you validate credentials again.
                isConnected = true;
                StateHasChanged();
            }
        }
        else
        {
            isConnected = false;
            Console.WriteLine("Error calling ConnectToStrava");
        }
        return isConnected;
    } 

    private static bool CheckIfCredentialsValid(IStravaUser user)
    {
        if (int.TryParse(user.AccessTokenExpiresAt, out var secondsEpoch))
        {
            DateTime tokenExpiryDateTime = DateTimeOffset.FromUnixTimeSeconds(secondsEpoch).UtcDateTime;
            return tokenExpiryDateTime > DateTime.UtcNow;
        }
        return false;
	}

    private async Task GetActivitiesAsync()
    {
        isLoading = true;
        isDataLoaded = false;
        string requestUri = $"{Options.Value.BaseAddress}/api/Strava/GetActivitiesAsync";
        try
        {
            var response = await Http.GetAsync(requestUri);            
            isDataLoaded = true;
            await GetStreamsAsync();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error fetching data: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task GetStreamsAsync(){
		isLoading = true;
		isDataLoaded = false;
		string requestUri = $"{Options.Value.BaseAddress}/api/Strava/GetStreamsAsync";
		try
		{
			var response = await Http.GetAsync(requestUri);
			if (response.IsSuccessStatusCode)
			{
				Console.WriteLine("Streams retrieved successfully.");
			}
			isDataLoaded = true;
		}
		catch (Exception ex)
		{
			Console.WriteLine($"Error fetching data: {ex.Message}");
		}
		finally
		{
			isLoading = false;
		}
    }

    public class JsonResponse
    {
        public string? Url { get; set; }
    }
}

<form>
    <button type="button" style="border: none; background: none; padding: 0;" @onclick="ConnectToStrava">
        <img src="images/btn_strava_connect_with_white.png" alt="Connect to Strava" style="height: 48px; cursor: pointer;" />
    </button>
</form>

<div>
@if (isStravaConnected)
    {
        <form>
            <button type="button" class="btn btn-primary" @onclick="() => GetActivitiesAsync()">Update activities</button>
        </form>
    }

    @if (isLoading)
    {
        <p>Loading...</p>
    }
    else if (isDataLoaded)
    {
        <h5>Activities retrieved!</h5>
    }
</div>
