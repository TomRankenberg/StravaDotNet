@page "/fetchdata"
@using Data.Models.Strava
@using System.Text.Json
@using Services
@inject NavigationManager Navigation
@inject AuthState AuthState
@inject HttpClient Http
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer
@code {
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var isLoggedIn = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "isLoggedIn");
            AuthState.IsLoggedIn = isLoggedIn == "true";
            if (!AuthState.IsLoggedIn)
            {
                Navigation.NavigateTo("/", true);
            }
            else
            {
                StateHasChanged();
            }
        }
    }
    private bool isLoading = false;
    private bool isDataLoaded = false;

    private async Task GetActivitiesAsync(int daysToRetrieve)
    {
        isLoading = true;
        isDataLoaded = false;
        string requestUri = "https://localhost:7237/api/Strava/GetActivitiesAsync";
        if (daysToRetrieve > 0)
		{
            DateTime dateCutoff = DateTime.Now.AddDays(-daysToRetrieve);
            int secondsAfter = (int)dateCutoff.Subtract(new DateTime(1970, 1, 1)).TotalSeconds;

			requestUri += $"?after={secondsAfter}";
		}
        try
        {
            var response = await Http.GetAsync(requestUri);            
            List<DetailedActivity> activities = await response.Content.ReadFromJsonAsync<List<DetailedActivity>>();
            isDataLoaded = true;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error fetching data: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task GetStreamsAsync(){
		isLoading = true;
		isDataLoaded = false;
		string requestUri = "https://localhost:7237/api/Strava/GetStreamsAsync";
		try
		{
			var response = await Http.GetAsync(requestUri);
			List<Stream> streams = await response.Content.ReadFromJsonAsync<List<Stream>>();
			if (streams != null && streams.Count > 0)
			{
				Console.WriteLine($"{streams.Count} Streams retrieved successfully.");
			}
			isDataLoaded = true;
		}
		catch (Exception ex)
		{
			Console.WriteLine($"Error fetching data: {ex.Message}");
		}
		finally
		{
			isLoading = false;
		}
    }
}

<div>
    <h5>Data retrieval</h5>
    <form>
        <button type="button" class="btn btn-primary" @onclick="() => GetActivitiesAsync(-1)">Fetch all data</button>
        <button type="button" class="btn btn-primary" @onclick="() => GetActivitiesAsync(30)">Fetch last month</button>
        <button type="button" class="btn btn-primary" @onclick="() => GetActivitiesAsync(7)">Fetch last week</button>
        <button type="button" class="btn btn-primary" @onclick="() => GetStreamsAsync()">Fetch data streams</button>
    </form>

    @if (isLoading)
    {
        <p>Loading...</p>
    }
    else if (isDataLoaded)
    {
        <h5>Activities retrieved!</h5>
    }
</div>
