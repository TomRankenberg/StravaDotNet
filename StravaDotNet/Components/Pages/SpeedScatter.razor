@page "/detailed-activity-plots"
@using Data.Models.Strava
@using StravaDotNet.ViewModels
@using Newtonsoft.Json
@using StravaDotNet.Components.Services
@inject DetailedActivityService detailedActivityService
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer

<h3>Detailed Activity Plots</h3>

<form class="load-data-form">
    <button type="button" class="btn btn-secondary" margin-right:30px @onclick="LoadData">Load Data</button>
</form>
@if (activityVms != null)
{
    <div class="canvas-container">
        <div class="canvas-wrapper">
            <canvas id="scatterPlotRun"></canvas>
        </div>
        <div class="canvas-wrapper">
            <canvas id="scatterPlotRide"></canvas>
        </div>
        <div class="canvas-wrapper">
            <canvas id="stackedBarsMonths"></canvas>
        </div>
        <div class="canvas-wrapper">
            <canvas id="stackedBarsHours"></canvas>
        </div>
        <div class="canvas-wrapper">
            <canvas id="heartRatePlot"></canvas>
        </div>
    </div>
}

@code {
    private List<ActivityVm> activityVms;

    private async Task LoadData()
    {
        activityVms = await detailedActivityService.GetDetailedActivitiesAsync();
        List<long?> activityIds = activityVms.Select(da => da.Activity.Id).ToList();
        PlotRunSpeed();
        PlotRideSpeed();
        PlotMonthlyActivities();
        PlotHourlyActivities();
        PlotHeartRate();
    }

    private async void PlotHeartRate()
    {
        if (activityVms != null)
        {
			List<ActivityVm> selectedActivities = activityVms.Where(da => da.AverageHeartRate != 0 && da.Activity.Type == "Run").ToList();
            string data = PrepareDataForHRPlot(selectedActivities);
			StateHasChanged();
            JSRuntime.InvokeVoidAsync("plotScatterChart", data, "heartRatePlot");
        }
    }

    private async void PlotRunSpeed()
    {
        if (activityVms != null)
        {
            List<ActivityVm> selectedActivities = activityVms.Where(da => da.Activity.Type == "Run").ToList();
            StateHasChanged();
			string data = PrepareDataForSpeedPlot(selectedActivities);
            JSRuntime.InvokeVoidAsync("plotScatterChart", data, "scatterPlotRide");
        }
    }

    private async void PlotRideSpeed()
    {
        if (activityVms != null)
        {
            List<ActivityVm> selectedActivities = activityVms.Where(da => da.Activity.Type == "Ride").ToList();
            StateHasChanged();
			string data = PrepareDataForSpeedPlot(selectedActivities);
            JSRuntime.InvokeVoidAsync("plotScatterChart", data, "scatterPlotRun");
        }
    }

    private async void PlotMonthlyActivities()
    {
        if (activityVms != null)
        {
            var filtereByActivity = activityVms.Where(da => da.Activity.Type == "Run" || da.Activity.Type == "Ride" || da.Activity.Type == "Swim").ToList();
            var groupedActivities = filtereByActivity
                           .GroupBy(da => new { da.Activity.StartDate.Value.Year, da.Activity.StartDate.Value.Month, da.Activity.Type })
                           .Select(g => new
                           {
                               Year = g.Key.Year,
                               Month = g.Key.Month,
                               Type = g.Key.Type,
                               Count = g.Count()
                           })
                           .ToList();

            var labels = groupedActivities
                .Select(g => $"{g.Year}-{g.Month:00}")
                .Distinct()
                .OrderBy(label => label)
                .ToList();

            var types = groupedActivities
                .Select(g => g.Type)
                .Distinct()
                .ToList();

            var datasets = types.Select(type => new
            {
                label = type,
                data = labels.Select(label =>
                {
                    var yearMonth = label.Split('-');
                    var year = int.Parse(yearMonth[0]);
                    var month = int.Parse(yearMonth[1]);
                    return groupedActivities
                        .Where(g => g.Year == year && g.Month == month && g.Type == type)
                        .Sum(g => g.Count);
                }).ToList()
            }).ToList();

            var chartData = new
            {
                labels,
                datasets
            };

            var jsonData = JsonConvert.SerializeObject(chartData);

			string stackedBarsMonths = "stackedBarsMonths";
            JSRuntime.InvokeVoidAsync("plotStackedBarChart", jsonData, stackedBarsMonths, "Year-Month");
        }
    }

    private async void PlotHourlyActivities()
    {
        if (activityVms != null)
        {
            var filtereByActivity = activityVms.Where(da => da.Activity.Type == "Run" || da.Activity.Type == "Ride" || da.Activity.Type == "Swim").ToList();
            var groupedActivities = filtereByActivity
                           .GroupBy(da => new { da.Activity.StartDateLocal.Value.Hour, da.Activity.Type })
                           .Select(g => new
                           {
                               Hour = g.Key.Hour,
                               Type = g.Key.Type,
                               Count = g.Count()
                           })
                           .ToList();

            var labels = groupedActivities
                .Select(g => $"{g.Hour:00}")
                .Distinct()
                .OrderBy(label => label)
                .ToList();

            var types = groupedActivities
                .Select(g => g.Type)
                .Distinct()
                .ToList();

            var datasets = types.Select(type => new
            {
                label = type,
                data = labels.Select(label =>
                {
                    var hour = int.Parse(label);
                    return groupedActivities
                        .Where(g => g.Hour == hour && g.Type == type)
                        .Sum(g => g.Count);
                }).ToList()
            }).ToList();

            var chartData = new
            {
                labels,
                datasets
            };

            var jsonData = JsonConvert.SerializeObject(chartData);

            string stackedBarsHours = "stackedBarsHours";

            JSRuntime.InvokeVoidAsync("plotStackedBarChart", jsonData, stackedBarsHours, "Hour of day");
        }
    }


	private string PrepareDataForSpeedPlot(List<ActivityVm> activities)
	{
        var minDate = activities.Min(da => da.Activity.StartDate);
        var maxDate = activities.Max(da => da.Activity.StartDate);

		var data = activities.Select(da => new
		{
			x = da.Activity.Distance / 1000,
			y = Math.Round((decimal)((da.Activity.Distance / da.Activity.MovingTime) * 3.6), 3),
			date = da.Activity.StartDate?.ToString("yyyy-MM-dd"),
            color = GetColorForDate(da.Activity.StartDate, minDate, maxDate)

		}).ToList();
		return JsonConvert.SerializeObject(data);
	}

    private string PrepareDataForHRPlot(List<ActivityVm> activities)
    {
        var minDate = activities.Min(da => da.Activity.StartDate);
        var maxDate = activities.Max(da => da.Activity.StartDate);

        var data = activities.Select(da => new
        {
            x = da.Activity.Distance / 1000,
            y = da.AverageHeartRate,
            date = da.Activity.StartDate?.ToString("yyyy-MM-dd"),
            color = GetColorForDate(da.Activity.StartDate, minDate, maxDate)

        }).ToList();
        return JsonConvert.SerializeObject(data);
    }

    private string GetColorForDate(DateTime? date, DateTime? minDate, DateTime? maxDate)
    {
        if (date == null || minDate == null || maxDate == null)
            return "rgba(75, 192, 192, 0.2)"; // Default color

        var totalDays = (maxDate.Value - minDate.Value).TotalDays;
        var daysFromStart = (date.Value - minDate.Value).TotalDays;
        var ratio = daysFromStart / totalDays;

        // Calculate color based on ratio (0.0 to 1.0)
        var red = (int)(255 * ratio);
        var green = (int)(192 * (1 - ratio));
        var blue = 192;

        return $"rgba({red}, {green}, {blue}, 0.8)";
    }
}

<style>
    .load-data-form {
        margin-bottom: 20px;
    }

    .canvas-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        gap: 20px;
    }

    .canvas-wrapper {
        flex: 1 1 calc(50% - 20px);
        max-width: calc(50% - 20px);
    }

    canvas {
        width: 100% !important;
        height: auto !important;
        border: 1px solid #ccc;
        box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.1);
    }
</style>

