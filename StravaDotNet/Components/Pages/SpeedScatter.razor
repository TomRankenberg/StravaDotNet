@page "/detailed-activity-plots"
@using Data.Models.Strava
@using StravaDotNet.ViewModels
@using Newtonsoft.Json
@using StravaDotNet.Components.Services
@inject DataRetrievalService dataRetrievalService
@inject PlottingHelperService plottingHelperService
@inject IJSRuntime JSRuntime
@rendermode InteractiveServer

<h3>Detailed Activity Plots</h3>

<form class="load-data-form">
    <button type="button" class="btn btn-secondary" margin-right:30px @onclick="LoadData">Load Data</button>
</form>
@if (activityVms != null)
{
    <div class="canvas-container">
    @foreach (var canvasId in canvasIds)
    {
        <div class="canvas-wrapper">
            <canvas id="@canvasId"></canvas>
        </div>
    }
    </div>
}

@code {
    private List<ActivityVm> activityVms;
    private readonly List<string> canvasIds = new()
    {
        "scatterPlotRun",
        "scatterPlotRide",
        "heartRatePlotRun",
		"heartRatePlotRide",
        "stackedBarsMonths",
        "stackedBarsHours",
        "cumulativeRunDistance",
        "cumulativeRideDistance",
		"cumulativeSwimDistance"
    };
    private HashSet<string> initializedCanvasIds = new();

    private async Task LoadData()
    {
        activityVms = await dataRetrievalService.GetAllActivitiesAsync();
        StateHasChanged(); // Trigger re-render to ensure the canvas elements are added to the DOM
        await PlotAllCharts();
    }

    private async Task PlotAllCharts()
    {
        if (activityVms != null)
        {
            await PlotChartIfNotInitialized("scatterPlotRun", PlotRunSpeed);
            await PlotChartIfNotInitialized("scatterPlotRide", PlotRideSpeed);
            await PlotChartIfNotInitialized("heartRatePlotRun", () => PlotHeartRate("Run"));
            await PlotChartIfNotInitialized("heartRatePlotRide", () => PlotHeartRate("Ride"));
            await PlotChartIfNotInitialized("stackedBarsMonths", PlotMonthlyActivities);
            await PlotChartIfNotInitialized("stackedBarsHours", PlotHourlyActivities);
            await PlotChartIfNotInitialized("cumulativeRunDistance", PlotCumulativeRunDistance);
            await PlotChartIfNotInitialized("cumulativeRideDistance", PlotCumulativeRideDistance);
            await PlotChartIfNotInitialized("cumulativeSwimDistance", PlotCumulativeSwimDistance);
        }
    }

    private async Task PlotChartIfNotInitialized(string canvasId, Func<Task> plotFunction)
    {
        if (!initializedCanvasIds.Contains(canvasId))
        {
            await plotFunction();
            initializedCanvasIds.Add(canvasId);
        }
    }

    private async Task PlotRunSpeed()
    {
        var selectedActivities = activityVms.Where(a => a.Activity.Type == "Run").ToList();
        var data = plottingHelperService.PrepareScatterPlotData(
            selectedActivities,
            a => a.Activity.Distance / 1000, // X-axis: Distance in km
            a => (a.Activity.Distance / a.Activity.MovingTime) * 3.6, // Y-axis: Speed in km/h
            a => PlottingHelperService.GetColorForDate(a.Activity.StartDate, activityVms.Min(a => a.Activity.StartDate), activityVms.Max(a => a.Activity.StartDate)),
			a => DateOnly.FromDateTime((DateTime)a.Activity.StartDate) // Tooltip: Date
        );

        await JSRuntime.InvokeVoidAsync("plotScatterChart", data, "scatterPlotRun");
    }

    private async Task PlotRideSpeed()
    {
        var selectedActivities = activityVms.Where(a => a.Activity.Type == "Ride").ToList();
        var data = plottingHelperService.PrepareScatterPlotData(
            selectedActivities,
            a => a.Activity.Distance / 1000, // X-axis: Distance in km
            a => (a.Activity.Distance / a.Activity.MovingTime) * 3.6, // Y-axis: Speed in km/h
            a => PlottingHelperService.GetColorForDate(a.Activity.StartDate, activityVms.Min(a => a.Activity.StartDate), activityVms.Max(a => a.Activity.StartDate)),
            a => DateOnly.FromDateTime((DateTime)a.Activity.StartDate) // Tooltip: Date
        );

        await JSRuntime.InvokeVoidAsync("plotScatterChart", data, "scatterPlotRide");
    }

    private async Task PlotHeartRate(string type)
    {
        var selectedActivities = activityVms.Where(a => a.AverageHeartRate != 0 && a.Activity.Type == type).ToList();
        var data = plottingHelperService.PrepareScatterPlotData(
            selectedActivities,
            a => a.Activity.Distance / 1000, // X-axis: Distance in km
            a => a.AverageHeartRate, // Y-axis: Heart rate
            a => PlottingHelperService.GetColorForDate(a.Activity.StartDate, activityVms.Min(a => a.Activity.StartDate), activityVms.Max(a => a.Activity.StartDate)),
            a => DateOnly.FromDateTime((DateTime)a.Activity.StartDate) // Tooltip: Date
        );

        await JSRuntime.InvokeVoidAsync("plotScatterChart", data, $"heartRatePlot{type}");

	}

    private async Task PlotMonthlyActivities()
    {
		List<ActivityVm> selectedActivities = activityVms
            .Where(a => a.Activity.Type == "Run" || a.Activity.Type == "Ride" || a.Activity.Type == "Swim")
			.ToList();
        var data = plottingHelperService.PrepareMonthlyBarChartData(selectedActivities);
        await JSRuntime.InvokeVoidAsync("plotStackedBarChart", data, "stackedBarsMonths", "Year-Month");
    }

    private async Task PlotHourlyActivities()
    {
        List<ActivityVm> selectedActivities = activityVms
            .Where(a => a.Activity.Type == "Run" || a.Activity.Type == "Ride" || a.Activity.Type == "Swim")
            .ToList();
        var data = plottingHelperService.PrepareHourlyBarChartData(selectedActivities);
        await JSRuntime.InvokeVoidAsync("plotStackedBarChart", data, "stackedBarsHours", "Hour of day");
    }

    private async Task PlotCumulativeRunDistance()
    {
        var selectedActivities = activityVms.Where(a => a.Activity.Type == "Run").ToList();
        var data = plottingHelperService.PrepareCumulativeDistanceData(selectedActivities, "Run");
        await JSRuntime.InvokeVoidAsync("plotLineChart", data, "cumulativeRunDistance", "Day/Month", "Cumulative Distance (km)");
    }

    private async Task PlotCumulativeRideDistance()
    {
        var selectedActivities = activityVms.Where(a => a.Activity.Type == "Ride").ToList();
        var data = plottingHelperService.PrepareCumulativeDistanceData(selectedActivities, "Ride");
        await JSRuntime.InvokeVoidAsync("plotLineChart", data, "cumulativeRideDistance", "Day/Month", "Cumulative Distance (km)");
    }

    private async Task PlotCumulativeSwimDistance()
    {
        var selectedActivities = activityVms.Where(a => a.Activity.Type == "Swim").ToList();
        var data = plottingHelperService.PrepareCumulativeDistanceData(selectedActivities, "Swim");
        await JSRuntime.InvokeVoidAsync("plotLineChart", data, "cumulativeSwimDistance", "Day/Month", "Cumulative Distance (km)");
    }

}

<style>
    .load-data-form {
        margin-bottom: 20px;
    }

    .canvas-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        gap: 20px;
    }

    .canvas-wrapper {
        flex: 1 1 calc(50% - 20px);
        max-width: calc(50% - 20px);
    }

    canvas {
        width: 100% !important;
        height: auto !important;
        border: 1px solid #ccc;
        box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.1);
    }
</style>